---
- hosts: localhost
  connection: local
  roles:
    - role: "{{ role_name }}"
  vars:
    docker_bridge_ip_cidr: "172.0.17.1/24"
  tasks:

    - name: Call Docker role
      include_role:
        name: indigo-dc.docker

    - name: "Create env file, download and start the docker compose file"
      block:

        - name: Set environment variables
          lineinfile:
            path: /usr/local/share/dodasts/jupyterhub/.env
            line: "{{ item.key }}={{ item.value }}"
            create: yes
          with_dict: "{{ environment_variables }}"

        - name: Add HOST_PUBLIC_IP and additional environment variables
          lineinfile:
            path: /usr/local/share/dodasts/jupyterhub/.env
            line: "{{ item.key }}={{ item.value }}"
            create: yes
          with_items:
             - { key: "HOST_PUBLIC_IP", value: "{% if IM_NODE_PUBLIC_IP is defined %}{{IM_NODE_PUBLIC_IP}}{% else %}{{IM_NODE_PRIVATE_IP}}{% endif %}" }
